name: Terraform Only (Safe Backend)

on:
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # üõ†Ô∏è Backend Ï†ÑÏö© Î¶¨ÏÜåÏä§ ÏÉùÏÑ± (Management Layer)
      - name: Ensure Terraform Backend Exists
        run: |
          set -e
          MGMT_RG="pilot-mgmt-rg"
          STORAGE_ACCOUNT="pilotbackendstorage123" # Ïù¥Î¶Ñ Ï§ëÎ≥µ Ï£ºÏùò (Ï†ÑÏó≠ Ïú†Ïùº)
          CONTAINER="tfstate"
          LOCATION="Canada Central"

          # 1. Í¥ÄÎ¶¨Ïö© Resource Group ÏÉùÏÑ±
          if ! az group show --name $MGMT_RG &>/dev/null; then
              echo "Creating Management RG: $MGMT_RG"
              az group create --name $MGMT_RG --location "$LOCATION"
          fi

          # 2. State Ï†ÄÏû•Ïö© Storage Account ÏÉùÏÑ±
          if ! az storage account show --name $STORAGE_ACCOUNT --resource-group $MGMT_RG &>/dev/null; then
              echo "Creating Backend Storage: $STORAGE_ACCOUNT"
              az storage account create \
                --name $STORAGE_ACCOUNT \
                --resource-group $MGMT_RG \
                --location "$LOCATION" \
                --sku Standard_LRS \
                --kind StorageV2
          fi

          # 3. Blob Container ÏÉùÏÑ±
          ACCOUNT_KEY=$(az storage account keys list --resource-group $MGMT_RG --account-name $STORAGE_ACCOUNT --query "[0].value" -o tsv)
          if ! az storage container exists --name $CONTAINER --account-name $STORAGE_ACCOUNT --account-key $ACCOUNT_KEY | grep true; then
              az storage container create --name $CONTAINER --account-name $STORAGE_ACCOUNT --account-key $ACCOUNT_KEY
          fi

      # üöÄ Terraform Ïã§Ìñâ (Service Layer)
      - name: Terraform Init
        run: terraform init
        working-directory: terraform

      - name: Terraform Plan
        run: terraform plan
        working-directory: terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform